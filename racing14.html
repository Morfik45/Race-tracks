<!DOCTYPE html>
<html>
<head>
    <title>Lap Timer</title>
    <style>
        body {
            margin: 0;
            font-family: sans-serif;
            background: #222;
            color: white;
        }

        #lapTimesWindow {
            position: absolute;
            top: 100px;
            left: 100px;
            width: 250px;
            background-color: rgba(0, 0, 0, 0.75);
            padding: 10px;
            border: 2px solid lightgreen;
            border-radius: 10px;
            resize: both;
            overflow: auto;
            cursor: move;
            z-index: 1000;
        }

        #lapTimesWindow h4 {
            margin: 0 0 10px 0;
            color: lightgreen;
        }

        #lapTimesWindow p {
            margin: 3px 0;
        }

        #exportBtn {
            position: absolute;
            padding: 5px 10px;
            background-color: lightgreen;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            z-index: 999;
        }

        #start, #restart {
            margin: 10px;
            padding: 10px;
            font-size: 16px;
        }
    </style>
</head>
<body>

    <button id="start">Start Race</button>
    <button id="restart">Restart Race</button>

    <div id="lapTimesWindow">
        <h4>Lap Times</h4>
        <div id="lapTimes"></div>
    </div>

    <button id="exportBtn">Export Lap Times</button>

    <script>
        const checkpoints = [
            {x: -2761.71, y: 8079.83, z: 42.83},
            {x: -2731.71, y: 8079.83, z: 42.83},
            {x: -2701.71, y: 8079.83, z: 42.83}
        ];

        let lap = 1;
        const nLaps = 3;
        let currentCheckpoint = 0;
        let lapTimes = [];
        let startTime = null;
        let isPlaying = false;
        let player_x = 0;
        let player_y = 0;

        const lapTimesWindow = document.getElementById("lapTimesWindow");
        const exportBtn = document.getElementById("exportBtn");

        function updateExportButtonPosition() {
            const rect = lapTimesWindow.getBoundingClientRect();
            exportBtn.style.top = rect.bottom + 5 + "px";
            exportBtn.style.left = rect.left + "px";
        }

        // Restore window position
        const savedPos = localStorage.getItem("lapWindowPos");
        if (savedPos) {
            const pos = JSON.parse(savedPos);
            lapTimesWindow.style.top = pos.top;
            lapTimesWindow.style.left = pos.left;
            updateExportButtonPosition();
        }

        // Drag logic
        let offsetX, offsetY, isDragging = false;
        lapTimesWindow.addEventListener("mousedown", (e) => {
            if (e.target === lapTimesWindow || e.target.tagName === 'H4') {
                isDragging = true;
                offsetX = e.clientX - lapTimesWindow.offsetLeft;
                offsetY = e.clientY - lapTimesWindow.offsetTop;
                e.preventDefault();
            }
        });

        document.addEventListener("mousemove", (e) => {
            if (isDragging) {
                lapTimesWindow.style.left = (e.clientX - offsetX) + "px";
                lapTimesWindow.style.top = (e.clientY - offsetY) + "px";
                updateExportButtonPosition();
            }
        });

        document.addEventListener("mouseup", () => {
            if (isDragging) {
                isDragging = false;
                localStorage.setItem("lapWindowPos", JSON.stringify({
                    top: lapTimesWindow.style.top,
                    left: lapTimesWindow.style.left
                }));
            }
        });

        function startRace() {
            isPlaying = true;
            lap = 1;
            currentCheckpoint = 0;
            lapTimes = [];
            document.getElementById("lapTimes").innerHTML = "";
            startTime = Date.now();
            checkLoop();
        }

        function checkLoop() {
            const interval = setInterval(() => {
                if (!isPlaying) {
                    clearInterval(interval);
                    return;
                }

                const checkpoint = checkpoints[currentCheckpoint];
                const dist = Math.sqrt((player_x - checkpoint.x) ** 2 + (player_y - checkpoint.y) ** 2);

                if (dist < 20) {
                    currentCheckpoint++;
                    if (currentCheckpoint >= checkpoints.length) {
                        const lapTime = Date.now() - startTime;
                        lapTimes.push(lapTime);
                        displayLapTime(lap, lapTime);
                        lap++;
                        if (lap > nLaps) {
                            isPlaying = false;
                        }
                        currentCheckpoint = 0;
                        startTime = Date.now();
                    }
                }
            }, 100);
        }

        function displayLapTime(lapNum, time) {
            const minutes = Math.floor(time / 60000);
            const seconds = Math.floor((time % 60000) / 1000);
            const millis = time % 1000;

            const line = document.createElement("p");
            line.textContent = `Lap ${lapNum}: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}:${millis.toString().padStart(3, '0')}`;
            document.getElementById("lapTimes").appendChild(line);
        }

        document.getElementById("start").onclick = startRace;
        document.getElementById("restart").onclick = () => location.reload();

        // Simulated player position update (replace with your game's method)
        setInterval(() => {
            player_x -= 10;
        }, 1000);

        // Export button logic
        exportBtn.addEventListener("click", (e) => {
            const lines = [];
            document.querySelectorAll("#lapTimes p").forEach(p => lines.push(p.textContent));
            const fullText = lines.join("\n");

            navigator.clipboard.writeText(fullText).catch(err => {
                console.error("Failed to copy:", err);
            });

            e.target.blur(); // Avoid softlock
        });

        // Keep export button under the window
        const resizeObserver = new ResizeObserver(updateExportButtonPosition);
        resizeObserver.observe(lapTimesWindow);
        updateExportButtonPosition();
    </script>
</body>
</html>

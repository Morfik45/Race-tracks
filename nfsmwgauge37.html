<html><head><style>
        #app {
            width: 100%;
            height: 100%;
            position: fixed;
            top: 0;
            left: 0;
            overflow: none;
            user-select: none;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
            margin: none;
            top: 0;
            left: 0;
            position: fixed;
        }
        #loader {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            z-index: 99;
        }
        
        .selected {
            background-color: #bcffa1;
        }
        
        #loaderdisclaimer {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 12px;
            max-width: 420px;
            margin: 20px auto;
            font-family: Verdana, sans-serif;
            text-align: left;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #loaderdisclaimer strong {
            font-size: 1.1em;
            color: #222;
        }

        #loaderdisclaimer p {
            font-size: 0.95em;
            color: #444;
            line-height: 1.5;
        }

        #loaderdisclaimer em {
            font-style: italic;
            color: #b00;
        }

        #loaderdisclaimer a {
            color: #007acc;
            text-decoration: none;
        }

        #loaderdisclaimer a:hover {
            text-decoration: underline;
        }
    </style>
    </head><body><div id="loader" style="display: none; top: 0px; max-width: 80vw;">
        <div id="loaderdisclaimer" style="display: none;">
            <strong>User-Generated Web Applications</strong><br>
            <p>Load tools and web applications directly into the game client. Find applications in <a href="#" id="discordlink">our discord</a>.</p>
            <p><strong>‚ö† Note:</strong> This application will get access to <em>game information</em>, <em>account information</em>, and may <em>act on your behalf</em>.</p>
            <p><strong><u>Only load trusted applications.</u></strong></p>
            <p>See <a href="#" id="wikilink">the wiki</a> for more information.</p>
        </div>
        <input type="text" id="app_url" placeholder="Application URL">
        <button id="load" disabled="">üîÉ Load</button>
        <button id="pin" style="display: inline;">üìå Pin</button>
        <button id="close_btn">üê±&zwj;üë§ Hide</button>
        <button id="remove_btn" style="display: inline;">‚ùå Remove Tab</button>
        <button id="newtab_btn" style="display: inline;">üìë New Tab</button>
    <button class="selected">(1) Speedometer Overlay</button></div>
    <div id="app" style="display: block;">
    <iframe src="https://morfik45.github.io/Race-tracks/nfsmwgauge37.html" style="z-index: 1; opacity: 1;"></iframe></div>
    <script>
        // send.onclick = () => {
        //     const message = "Sent from outside.html";
        //     document.querySelector("#frame").contentWindow.postMessage({
        //         message: message,
        //     }, "*");
        // };
        let isInFocus = false;
        let hasLoadedAnyTabs = false;
        const tabs = [];
        let currentTab = 0;
        const maxTabs = 10;

        const getAllAppURLs = () => {
            let urls = [];
            for (const tab in tabs) {
                urls.push(tabs[tab][0].src);
            }
            return urls;
        }

        wikilink.onclick = () => {
            const url = "https://dash.tycoon.community/wiki/index.php/User_Applications";
            window.invokeNative("openUrl", url);
        }
        discordlink.onclick = () => {
            const url = "https://discord.com/channels/307266366174658560/1326953908836241469";
            window.invokeNative("openUrl", url);
        }
        const sendData = (data) => {
            if (!data.data) {
                let newData = data;
                data = {data: newData};
            }
            for (const tab in tabs) {
                tabs[tab][0].contentWindow.postMessage(data, "*");
            }
        }
        const updateTabs = () => {
            for (const tab in tabs) {
                tabs[tab][0].contentWindow.postMessage({data: {tabbed: tab == currentTab}}, "*");
            }
        }
        const runEvent = (name, data, cb) => {
            data = data || {};
            fetch(`https://${GetParentResourceName()}/${name}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json; charset=UTF-8',
                },
                body: JSON.stringify(data)
            }).then((response) => response.json()).then((data) => {
                if (cb) {
                    cb(data);
                }
            }).catch((error) => {
                console.error('Error:', error);
            });
        }
        pin.onclick = () => {
            runEvent("pin");
        };
        close_btn.onclick = () => {
            runEvent("close");
        };
        remove_btn.onclick = () => {
            tabs[currentTab][0].remove();
            tabs[currentTab][1].remove();
            tabs.splice(currentTab, 1);
            setTab(currentTab);
            runEvent("updatedUrls", {urls: getAllAppURLs()});

            if (Object.keys(tabs).length == 0) {
                app.style.display = "none";
                loader.style.top = "50%";
                pin.style.display = "none";
                remove_btn.style.display = "none";
                newtab_btn.style.display = "none";
                loaderdisclaimer.style.display = "block";
                hasLoadedAnyTabs = false;
            }
        }
        const fadeOutUnfocusedTabs = () => {
            if (!isInFocus) {
                return;
            }
            for (const tab in tabs) {
                if (tab != currentTab) {
                    tabs[tab][0].style.opacity = "0.5";
                } else {
                    tabs[tab][0].style.opacity = "1";
                }
            }
        }
        const fadeInAllTabs = () => {
            for (const tab in tabs) {
                tabs[tab][0].style.opacity = "1";
            }
        }
        const setTab = (tab) => {
            // Recursively set the tab to the next one if it doesn't exist
            if (tab < 0) { return; }
            if (tabs[tab] == undefined) { return setTab(tab - 1); }

            for (const tab in tabs) {
                tabs[tab][0].style.zIndex = "0";
                tabs[tab][1].classList.remove("selected");
            }
            tabs[tab][0].style.zIndex = "1";
            tabs[tab][1].classList.add("selected");
            currentTab = tab;
            updateTabs();
            fadeOutUnfocusedTabs();
        }
        const setUrl = (tab, url) => {
            if (tabs[tab] == undefined) {
                if (tab >= maxTabs) {
                    return;
                }
                if (url.startsWith("nui://")) {
                    console.log("Cannot load nui:// URLs");
                    return;
                }
                
                tabs[tab] = {};
                tabs[tab][0] = document.createElement("iframe");
                app.appendChild(tabs[tab][0]);
                tabs[tab][1] = document.createElement("button");
                tabs[tab][1].textContent = "Tab " + tab;
                tabs[tab][1].onclick = () => {
                    setTab(tab);
                };
                tabs[tab][0].onload = () => {
                    let title = tabs[tab][0].contentWindow.document.title;
                    if (title.length > 0) {
                        tabs[tab][1].textContent = `(${tab + 1}) ` + title;
                    } else {
                        tabs[tab][1].textContent = `(${tab + 1}) ` + url;
                    }
                };
                document.querySelector("#loader").appendChild(tabs[tab][1]);
            }
            hasLoadedAnyTabs = true;
            tabs[tab][0].src = url;
            document.querySelector("#app_url").value = "";
            app.style.display = "block";
            loader.style.top = "0";
            pin.style.display = "inline";
            remove_btn.style.display = "inline";
            newtab_btn.style.display = "inline";
            loaderdisclaimer.style.display = "none";
            load.disabled = true;
            fadeOutUnfocusedTabs();
        }
        newtab_btn.onclick = () => {
            currentTab = Object.keys(tabs).length;
            setUrl(currentTab, "");
        };
        load.onclick = () => {
            const url = document.querySelector("#app_url").value;
            setUrl(currentTab, url);
            setTab(currentTab);
            runEvent("updatedUrls", {urls: getAllAppURLs()});
            runEvent("appRequest", {type: "getData"});
        };
        app_url.oninput = () => {
            const url = document.querySelector("#app_url").value;
            if (url.length > 0) {
                load.disabled = false;
            } else {
                load.disabled = true;
            }
        };
        const escapeListener = (e) => {
            if (e.key === "Escape") {
                if (hasLoadedAnyTabs) {
                    runEvent("pin");
                } else {
                    runEvent("close");
                }
            }
            if (e.keyCode === 9) {
                e.preventDefault();
                currentTab++;
                if (currentTab >= Object.keys(tabs).length) {
                    currentTab = 0;
                }
                setTab(currentTab);
            }
        };
        setTab(0);
        window.addEventListener('keydown', escapeListener);
        window.addEventListener("message", (event) => {
            if (!event.data.fromTycoonScript) {
                // Send the request to script
                if (event.data.type == "api") {
                    
                }
                runEvent("appRequest", {source: event.source.location.href, ...event.data});
                console.log(event.source.location.href, event.data.type, JSON.stringify(event.data));
            } else {
                const type = event.data.type;
                if (type == "data") {
                    // Send the response to the iframe
                    sendData(event.data);
                } else if (type == "close") {
                    isInFocus = false;
                    sendData({"focused": false, "hidden": true, "pinned": false});
                    app.style.display = "none";
                    loader.style.display = "none";
                } else if (type == "pin") {
                    isInFocus = false;
                    sendData({"focused": false, "hidden": false, "pinned": true});
                    fadeInAllTabs();
                    loader.style.display = "none";
                } else if (type == "open") {
                    isInFocus = true;
                    setTab(currentTab);
                    sendData({"focused": true, "hidden": false, "pinned": false});
                    fadeOutUnfocusedTabs();
                    app.style.display = "block";
                    loader.style.display = "block";
                } else if (type == "url") {
                    setUrl(event.data.tab, event.data.url);
                }
            }
        });
    </script>
</body></html>

<!DOCTYPE html>
<html>
<head>
    <title>Roxwood Circuit Grand Track</title>
    <style>
        body {
            font-family: impact;
            background-color: transparent;
            color: white;
            position: absolute;
            left: 410px;
            bottom: 50px;
            font-size: 1.5em;
            line-height: 3px;
            text-shadow: -2px -2px 0 #000, 2px -2px 0 #000, -2px 2px 0 #000, 2px 2px 0 #000;
        }

        #lapTimesWindow {
            position: absolute;
            top: 50px;
            left: 50px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border: 2px solid lightgreen;
            border-radius: 10px;
            font-family: sans-serif;
            font-size: 1em;
            line-height: 1.4em;
            color: white;
            z-index: 1000;
            resize: both;
            overflow: auto;
            min-width: 200px;
            max-width: 400px;
        }

        #lapTimesWindow h4 {
            margin: 0 0 8px 0;
            color: lightgreen;
        }

        #lapTimesWindow p {
            margin: 3px 0;
        }
    </style>
</head>
<body>

<div class="container">
    <button id="start">Start Race</button>
    <button id="restart">Restart Race</button>
    <p style="color:#f0c850; font-size: 1.15em; line-height: 22px">Roxwood Circuit Grand Track</p>
    <p style="color:lightgreen">Author: <span style="color:white">Morfik</span></p>
    <!-- Removed checkpoint line -->
    <p style="color:lightgreen">Lap: <span style="color:white" id="rlap">1/3</span></p>
    <span style="color: white" id="timer">00:00:000</span>
    <p id="totalTime" style="color: lightgreen; font-size: 1.2em; display: none;">Total Time: <span style="color: white;" id="totalTimeValue"></span></p>
</div>

<div id="lapTimesWindow">
    <h4>Lap Times</h4>
    <div id="lapTimes"></div>
</div>

<script>
    const checkpoints = [
        {x: -2761.71, y: 8079.83, z: 42.83},
        {x: -2643.92, y: 8075.96, z: 44.00},
        {x: -2553.67, y: 8089.94, z: 45.82},
        {x: -2458.77, y: 8203.97, z: 40.84},
        {x: -2520.50, y: 8238.66, z: 38.50},
        {x: -2547.66, y: 8197.51, z: 37.80},
        {x: -2624.50, y: 8150.65, z: 40.67},
        {x: -2691.51, y: 8203.01, z: 40.78},
        {x: -2682.30, y: 8374.90, z: 40.77},
        {x: -2647.02, y: 8449.41, z: 40.95},
        {x: -2412.95, y: 8513.98, z: 45.88},
        {x: -2260.20, y: 8566.00, z: 46.29},
        {x: -2296.16, y: 8684.64, z: 46.12},
        {x: -2349.59, y: 8831.05, z: 47.94},
        {x: -2362.52, y: 8905.74, z: 50.63},
        {x: -2383.28, y: 8852.79, z: 47.52},
        {x: -2447.24, y: 8760.09, z: 44.19},
        {x: -2595.08, y: 8757.01, z: 46.57},
        {x: -2782.19, y: 8742.51, z: 44.41},
        {x: -2993.76, y: 8829.73, z: 43.22},
        {x: -3091.84, y: 8820.91, z: 39.59},
        {x: -3056.31, y: 8758.33, z: 36.78},
        {x: -2859.98, y: 8726.67, z: 32.60},
        {x: -2783.76, y: 8664.23, z: 30.93},
        {x: -2857.62, y: 8642.45, z: 30.99},
        {x: -3017.52, y: 8704.58, z: 44.62},
        {x: -3069.38, y: 8660.97, z: 37.52},
        {x: -3217.67, y: 8668.39, z: 35.47},
        {x: -3257.30, y: 8576.98, z: 36.38},
        {x: -3157.41, y: 8435.00, z: 36.52},
        {x: -2958.70, y: 8412.21, z: 36.37},
        {x: -2903.70, y: 8328.44, z: 36.38},
        {x: -3030.19, y: 8302.39, z: 36.49},
        {x: -3200.89, y: 8252.35, z: 41.70},
        {x: -3133.18, y: 8123.32, z: 44.90},
        {x: -2962.77, y: 8106.87, z: 44.21},
        {x: -2761.71, y: 8079.83, z: 42.83}
    ];

    let player_x = 0;
    let player_y = 0;

    const setCheckpoint = (x, y) => {
        window.parent.postMessage({type: "setWaypoint", x: x, y: y}, "*");
    };

    const sfx = (num) => {
        window.parent.postMessage({type: "sfx", sfx: num}, "*");
    };

    const dist = (x1, y1, x2, y2) => {
        return Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);
    };

    let isPlaying = false;

    const startGame = () => {
        let firstCp = false;
        let startTime = 0;
        let nLaps = 3;
        let lap = 1;
        let currentCheckpoint = 0;
        const lapTimes = [];

        document.getElementById("start").style.display = "none";
        document.getElementById("restart").style.display = "inline-block";
        isPlaying = true;

        setCheckpoint(checkpoints[currentCheckpoint].x, checkpoints[currentCheckpoint].y);

        const gameInterval = setInterval(() => {
            if (!isPlaying) {
                clearInterval(gameInterval);
                return;
            }

            if (dist(player_x, player_y, checkpoints[currentCheckpoint].x, checkpoints[currentCheckpoint].y) < 25) {
                if (!firstCp) {
                    startTime = new Date().getTime();
                }
                firstCp = true;
                currentCheckpoint++;

                if (currentCheckpoint >= checkpoints.length) {
                    lap++;
                    const currentTime = new Date().getTime();
                    const lapTime = currentTime - startTime;
                    lapTimes.push(lapTime);

                    const lapTimeElem = document.createElement("p");
                    const minutes = Math.floor(lapTime / 60000);
                    const seconds = Math.floor((lapTime % 60000) / 1000);
                    const millis = lapTime % 1000;
                    lapTimeElem.innerHTML = `<span style="color: lightgreen;">Lap ${lap - 1}:</span> <span style="color: white;">${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}:${millis.toString().padStart(3, "0")}</span>`;
                    document.getElementById("lapTimes").appendChild(lapTimeElem);

                    startTime = currentTime;

                    if (lap > nLaps) {
                        sfx(5); // Finish Audio
                        firstCp = false;
                        isPlaying = false;

                        const totalTime = lapTimes.reduce((a, b) => a + b, 0);
                        const totalMinutes = Math.floor(totalTime / 60000);
                        const totalSeconds = Math.floor((totalTime % 60000) / 1000);
                        const totalMillis = totalTime % 1000;
                        document.getElementById("totalTimeValue").innerText = `${totalMinutes.toString().padStart(2, "0")}:${totalSeconds.toString().padStart(2, "0")}:${totalMillis.toString().padStart(3, "0")}`;
                        document.getElementById("totalTime").style.display = "block";
                    } else {
                        sfx(3); // Next Lap Audio
                        currentCheckpoint = 0;
                        setCheckpoint(checkpoints[currentCheckpoint].x, checkpoints[currentCheckpoint].y);
                    }
                } else {
                    setCheckpoint(checkpoints[currentCheckpoint].x, checkpoints[currentCheckpoint].y);
                    sfx(2); // Checkpoint Audio
                }
            }

            if (firstCp) {
                document.getElementById("rlap").innerText = `${lap}/${nLaps}`;
                let time = (new Date().getTime() - startTime);
                const minutes = Math.floor(time / 60000);
                time -= minutes * 60000;
                const seconds = Math.floor(time / 1000);
                time -= seconds * 1000;
                const millis = Math.floor(time);
                document.getElementById("timer").innerText = `${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}:${millis.toString().padStart(3, "0")}`;
            }
        }, 10);
    };

    document.getElementById("start").onclick = startGame;
    document.getElementById("restart").onclick = () => location.reload();

    window.addEventListener("message", (event) => {
        if (event.data.data["pos_x"]) player_x = event.data.data["pos_x"];
        if (event.data.data["pos_y"]) player_y = event.data.data["pos_y"];
    });

    window.addEventListener('keydown', (e) => {
        if (e.key === "Escape") {
            window.parent.postMessage({type: "pin"}, "*");
        }
    });
</script>

</body>
</html>
